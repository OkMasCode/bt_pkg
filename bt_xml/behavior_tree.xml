<root main_tree_to_execute="MainTree" BTCPP_format="4">

    <BehaviorTree ID="MainTree">

        <Sequence name="MissionPipeline">

            <ReadJson 
                file_path="/workspaces/ros2_ws/src/yolo11_seg_bringup/config/robot_command.json"
                candidates_ids="{candidates}" 
                similarity_scores="{similarity_scores}"
                goal_poses="{goal_poses}"
                prompt="{clip_prompt}" 
                cluster="{cluster}" 
                cluster_centroid="{cluster_centroid}"
                cluster_dimensions="{cluster_dimensions}"
                action="{robot_action}"
            />

            <GetRobotStartPose 
                start_pose="{start_pose}"
                tf_topic="/tf"
                frame_id="base_link"
            />

            <Sequence name="DecideAndNavigate">

                <SelectGoal 
                    candidates_ids="{candidates}" 
                    similarity_scores="{similarity_scores}"
                    goal_poses="{goal_poses}"
                    cluster_centroid="{cluster_centroid}"
                    similarity_threshold="8.0"
                    target_pose="{target_pose}"
                    is_object_goal="{is_object}"
                />
                
                <Fallback name="ChooseNavigationStrategy">

                    <CheckIsObject is_object="{is_object}"/>

                    <Sequence name="ExploreCluster">

                        <FindApproachPose
                            goal_pose="{cluster_centroid}"
                            approach_pose="{exploration_pose}"
                            costmap_topic="/global_costmap/costmap"
                            min_radius="0.0"
                            max_radius="3.0"
                            radius_step="0.1"
                            angle_step_deg="20.0"
                            free_threshold="0"
                        />

                        <NavigateToPose goal="{exploration_pose}"/>

                        <ReactiveFallback name="ExploreUntilFound">

                            <CheckGoalSeen 
                                goal_pose = "{target_pose}"
                                goal_topic = "/detected_object_pose"
                            />

                            <Repeat num_cycles="-1" name="InfiniteExploration">

                                <Sequence name="ExplorationStep">

                                    <GetNextPoint 
                                        next_point="{exploration_pose}"
                                        cluster_centroid="{cluster_centroid}"
                                        cluster_dimensions="{cluster_dimensions}"
                                    />

                                    <NavigateToPose goal="{exploration_pose}"/>

                                    <Rotate360 angle_increment="45.0"/>
                                    
                                </Sequence>
                            </Repeat>

                        </ReactiveFallback>

                    </Sequence>

                </Fallback>

                <Sequence name="NavigateToGoal">

                        <FindApproachPose
                            goal_pose="{target_pose}"
                            approach_pose="{approach_pose}"
                            costmap_topic="/global_costmap/costmap"
                            min_radius="0.0"
                            max_radius="3.0"
                            radius_step="0.1"
                            angle_step_deg="20.0"
                            free_threshold="0"
                        />

                        <NavigateToPose goal="{approach_pose}"/>

                </Sequence>

                <Fallback name="PostArrivalLogic">

                    <Sequence name="BringBackObject">

                        <CheckAction action="{robot_action}"/>

                        <NavigateToPose goal="{start_pose}"/>

                    </Sequence>

                </Fallback>

            </Sequence>

        </Sequence>
        
    </BehaviorTree>

    <TreeNodesModel>
        <Action ID="ReadJson">
            <input_port name="file_path"/>
            <output_port name="candidates_ids"/>
            <output_port name="similarity_scores"/>
            <output_port name="goal_poses"/>
            <output_port name="prompt"/>
            <output_port name="cluster"/>
            <output_port name="cluster_centroid"/>
            <output_port name="cluster_dimensions"/>
            <output_port name="action"/>
        </Action>
        <Action ID="GetRobotStartPose">
            <input_port name="tf_topic"/>
            <input_port name="frame_id"/>
            <output_port name="start_pose"/>
        </Action>
        <Action ID="SelectGoal">
            <input_port name="candidates_ids"/>
            <input_port name="similarity_scores"/>
            <input_port name="goal_poses"/>
            <input_port name="cluster_centroid"/>
            <input_port name="similarity_threshold"/>
            <output_port name="target_pose"/>
            <output_port name="is_object_goal"/>
        </Action>
        <Action ID="FindApproachPose">
            <input_port name="goal_pose"/>
            <input_port name="costmap_topic"/>
            <input_port name="min_radius"/>
            <input_port name="max_radius"/>
            <input_port name="radius_step"/>
            <input_port name="angle_step_deg"/>
            <input_port name="free_threshold"/>
            <output_port name="approach_pose"/>
        </Action>
        <Action ID="NavigateToPose">
            <input_port name="goal"/>
        </Action>
        <Action ID="CheckGoalSeen">
            <input_port name="goal_topic"/>
            <output_port name="goal_pose"/>
        </Action>
        <Action ID="GetNextPoint">
            <input_port name="cluster_centroid"/>
            <input_port name="cluster_dimensions"/>
            <output_port name="next_point"/>
        </Action>
        <Condition ID="CheckIsObject">
            <input_port name="is_object"/>
        </Condition>
        <Condition ID="CheckAction">
            <input_port name="action"/>
        </Condition>
        <Action ID="Rotate360">
            <input_port name="angle_increment"/>
        </Action>
    </TreeNodesModel>
</root>